class MiniJs{prefix="";elements=[];listElements={};listContainer={};container=document;allKey=[];detectValueChanges={};constructor(e,t={}){let{parentSelector:r="html",prefix:i="md-",detectValueChanges:l={}}=t;this.lib=ObservableSlim.create(e,!0,this.detectChanges.bind(this)),this.container=document.querySelector(r),this.prefix=i,this.detectValueChanges=l}init(e){let t=this.generateDefaultObjectType(e);t.forEach(e=>{this.allKey.push(e.currentPath)}),this.initForLoop(e),this.performOperation(t),this.initInputChanges(t)}detectChanges(e){let t=e,r=e.filter(e=>"object"==typeof e.newValue&&null!=e.newValue),i=e.filter(e=>"object"!=typeof e.newValue);if(r.length){let l=[];r.forEach(t=>{let r,i=t.currentPath;if(Array.isArray(t.newValue)||!isNaN(t.property))(r=e).push({type:"add",newValue:t.newValue.length,currentPath:`${e[0].currentPath}.length`,target:t});else{let a=i.split("."),o=i;a.length>1&&(o=a.pop()),r=this.generateDefaultObjectType(this.getValueFromkeyWithDot(t.target,o),i)}l=[...l,...r]}),t=[...l,...i]}this.performOperation(t),t.forEach(e=>{this.detectValueChanges[e.currentPath]&&this.detectValueChanges[e.currentPath](e.newValue)})}initClassAndAttributeValue(){this.container.querySelectorAll()}convertStringToFunction(e){let t=e.replaceAll(/[\s+()]/g,"").replaceAll(/(&&|\|\|)/g,"__").replaceAll(/(!*)(=+)/g,"__").split("__").filter(e=>'"'!=e[0]&&"'"!=e[0]&&isNaN(e)).map(t=>{"!"==t[0]&&(t=t.replaceAll("!",""));let r=this.getValueFromkeyWithDot(this.lib,t),i=t;return(t.includes(".")&&(i="fnVar"+this.randomIntFromInterval(1,1e3),e=e.replaceAll(t,i)),(isNaN(r)||""===r)&&void 0!=r&&null!=r)?`${i}='${r}'`:`${i}=${r}`});return Function(...t,`return ${e}`)}randomIntFromInterval(e,t){return Math.floor(Math.random()*(t-e+1)+e)}performAllOperationForAllItsChildNodes({item:e,ele:t,selector:r,cb:i,flag:l=!1}){let a=t.getAttribute(`${r}`);if(a){a.startsWith("!")&&(a=a.slice(1));i(t,this.getValueFromkeyWithDot(e.newValue,a))}else{let o=t.querySelectorAll(`[${r}]`);o.forEach(t=>{this.performAllOperationForAllItsChildNodes({item:e,ele:t,selector:r,cb:i,flag:l})})}}replaceAllKeyToValueWithRegex(e){let t=this.getAllKeyFromAttrWithBraces(e);return t.forEach(t=>{if(t){let r=RegExp(`{{\\s*(${t}?)\\s*}}`);r.exec(e)&&(e=e.replace(r,(e,r)=>{let i=this.getValueFromkeyWithDot(this.lib,t);return i||0==i?i:""}))}}),e}getAllKeyFromAttrWithBraces(e){let t=/\{\{(.+?)\}\}/g,r=[],i;for(;null!==(i=t.exec(e));)r.push(i[1]);return r}performOperation(e){e.forEach(e=>{let t=this.getMainKeyFromCurrentPath(e.currentPath);e.currentPath.endsWith(".length")||(this.performLoopOperation(e,t),this.performAttributeAddOpeartaion(e,t),this.performTextOperation(e,t),this.performInputOperation(e,t)),this.performDisabledValue(e),this.performClassOpeartion(e,t),this.performIfStatementOperation(e,t)})}performDisabledValue(e){let t=this.container.querySelectorAll(`[${this.prefix}disabled*="${e.currentPath}"]`);try{t.forEach(e=>{let t=e.getAttribute(`${this.prefix}disabled`);this.convertStringToFunction(t)()?e.disabled=!1:e.disabled=!0})}catch(r){console.log(r)}}performClassOpeartion(e){let t=this.container.querySelectorAll(`[${this.prefix}class*="${e.currentPath}"]`);t.forEach(e=>{this.updateClassFromBindProperty(e)})}updateClassFromBindProperty(e){let t=e.getAttribute(`${this.prefix}class`);if(t.startsWith("{")){let r=JSON.parse(t);for(let i in r)this.addOrRemoveClassFromElement(r[i],i,e)}else t.split(";").forEach(t=>{let r=t.split("=").map(e=>e.trim());t=t.substring(t.indexOf("=")+1);let i=this.removeQuoteAndDoubleQuote(r[0]);this.addOrRemoveClassFromElement(t.trim(),i,e)})}removeQuoteAndDoubleQuote(e){return e.replace(/['"]+/g,"")}addOrRemoveClassFromElement(e,t,r){let i=this.convertStringToFunction(e);i()?r.classList.add(t):r.classList.remove(t)}performAttributeAddOpeartaion(e,t,r){let i=this.container.querySelectorAll(`[${this.prefix}attr*="${e.currentPath}"]`);i.length&&i.forEach(t=>{this.updateAttributeValueForAttr(e,t)})}updateAttributeValueForAttr(e,t,r=""){let i=t.getAttribute(`${this.prefix}attr`).split(";");i.forEach(i=>{let l=i.split("=").map(e=>e.trim()),a=this.getValueFromkeyWithDot(r?e.newValue:this.lib,r||l[1]);if(a){let o=this.removeQuoteAndDoubleQuote(l[0]);t.setAttribute(o,a)}})}performIfStatementOperation(e){let t=this.container.querySelectorAll(`[${this.prefix}if*="${e.currentPath}"]`);try{t.forEach(e=>{let t=e.getAttribute(`${this.prefix}if`),r=this.convertStringToFunction(t),i=e.getAttribute(`${this.prefix}display`)??"block";r()?e.style.display=i:e.style.display="none"})}catch(r){console.log(r)}}hideShowELement(e,t,r=!1){let i=t.getAttribute(`${this.prefix}if`);if(i){let l=t.getAttribute(`${this.prefix}display`)??"block";if(i.includes("=")){let a=this.checkCondition(e,t,"",i,!1);a?t.style.display=l:t.style.display="none"}else this.performAllOperationForAllItsChildNodes({flag:r,item:e,ele:t,selector:`${this.prefix}if`,cb(e,t){t&&"!"!=i[0]||!t&&"!"==i[0]?e.style.display=l:e.style.display="none"}})}}performTextOperation(e){let t=this.container.querySelectorAll(`[${this.prefix}text*="${e.currentPath}"]`);t.length&&t.forEach(t=>{this.modifyMdTextValue(e,t)})}modifyMdTextValue(e,t,r=!1){let i=t.getAttribute(`${this.prefix}text`);if(!i){let l=t.querySelectorAll(`[${this.prefix}text]`);l.forEach(t=>{this.modifyMdTextValue(e,t,r)});return}let a;if(i==e.currentPath)a=this.getValueFromkeyWithDot(this.lib,i);else{if(!(!r&&i?.includes("{{")))return;a=this.replaceAllKeyToValueWithRegex(i,this.allKey)}t.textContent=a}performInputOperation(e){let t=this.container.querySelectorAll(`[${this.prefix}input="${e.currentPath}"]:not([type="checkbox"],[type="radio"])`);if(t.length)t.forEach(t=>{this.modifyMdInputValue(e,t)});else{let r=this.container.querySelectorAll(`[${this.prefix}input="${e.currentPath}"][type="radio"]`);r.forEach(t=>{t.value==e.newValue&&(t.checked=!0)});let i=this.container.querySelector(`[${this.prefix}input="${e.currentPath}"][type="checkbox"]`);i&&i.value==e.newValue&&(i.checked=!0)}}modifyMdInputValue(e,t,r=!1){this.performAllOperationForAllItsChildNodes({flag:r,item:e,ele:t,selector:`${this.prefix}input`,cb(e,t){e.value=t}})}performInputChangeEvent(e){let t=e.target.getAttribute(`${this.prefix}input`).split("."),r=t.pop(),i=this.lib;if(t.forEach(e=>{i=i?.[e]}),"radio"==e.target.type||"checkbox"==e.target.type){let l=`[${this.prefix}input="${e.target.getAttribute(this.prefix+"input")}"]`;if("checkbox"==e.target.type&&this.container.querySelectorAll(l).length>1){e.target.checked?(Array.isArray(i[r])||(i[r]=[]),i[r].push(e.target.value)):i[r].length&&(i[r]=i[r].filter(t=>t!=e.target.value));return}e.target.checked?i[r]=e.target.value:i[r]=""}else"checkbox"==e.target.type||(i[r]=e.target.value)}initInputChanges(e){this.container.querySelector(`[${this.prefix}input]`)&&(this.addFormEventToResetitsValue(),e.forEach(e=>{if("length"!=e.property){if("object"!=typeof e.newValue||Array.isArray(e.newValue)){let t=e.currentPath;this.attachedEventToForm(t)}else{let r=e.currentPath,i=this.generateKeyWithDotSeperated(e.newValue);i.forEach(e=>{let t=`${r}.${e}`;this.attachedEventToForm(t)})}}}))}addFormEventToResetitsValue(){let e=this.container.querySelectorAll("form");e.forEach(e=>{e.addEventListener("reset",e=>{let t=e.target.querySelectorAll(`[${this.prefix}input]`);t.forEach(e=>{let t=e.getAttribute(`${this.prefix}input`).split("."),r=t.pop(),i=this.lib;t.forEach(e=>{i=i?.[e]}),i[r]=""})})})}attachedEventToForm(e){let t=this.container.querySelectorAll(`[${this.prefix}input="${e}"]`);t.length&&t.forEach(e=>{let t=e.getAttribute("type");if("INPUT"!=e.tagName||t&&("radio"==t||"checkbox"==t))e.removeEventListener("change",this.performInputChangeEvent.bind(this)),e.addEventListener("change",this.performInputChangeEvent.bind(this)),"SELECT"==e.tagName&&"undefined"!=typeof jQuery&&jQuery(this.container).on("select2:select",e,e=>{this.performInputChangeEvent(e)});else{e.removeEventListener("keyup",this.processChangeKeyUpEvent.bind(this));let r;e.addEventListener("keyup",e=>{clearTimeout(r),r=setTimeout(()=>{this.performInputChangeEvent(e)},300)})}})}getMainKeyFromCurrentPath(e){let t=e.split(".");return t.length>1&&!isNaN((t=e.split("."))[t.length-1])&&t.pop(),t.join(".")}getValueFromkeyWithDot(e,t){return"object"==typeof e&&t.split(".").map(t=>{e=e?.[t]}),e}generateDefaultObjectType(e,t=""){let r=[];if(t&&(t+="."),Array.isArray(e)){let i=e.map((r,i)=>({type:"add",target:e,currentPath:`${t}${i}`,newValue:r}));return t.endsWith(".")&&(t=t.slice(0,t.length-1)),(r=[...r,...i]).push({type:"add",target:e,currentPath:`${t}.length`,newValue:e.length}),r}for(let l in e)if("object"==typeof e[l]){let a=this.generateDefaultObjectType(e[l],t+l);r=[...r,...a]}else r.push({type:"add",target:e,currentPath:`${t}${l}`,newValue:e[l]});return r}generateKeyWithDotSeperated(e={},t=""){t&&(t+=".");let r=[];if("object"==typeof e&&!Array.isArray(e))for(let i in e){let l=this.generateKeyWithDotSeperated(e[i],t+i);r=[...r,...l]}return t&&r.push(t.slice(0,t.lastIndexOf("."))),r}removeAllchildNodes(e){for(;e.firstChild;)e.removeChild(e.firstChild)}performLoopEachItem({item:e,key:t,elements:r}){"add"==e.type?this.addPropertyInLoop({item:e,key:t,elements:r}):"update"==e.type?this.updatePropertyInLoop({item:e,key:t,elements:r}):"delete"==e.type&&this.deletePropertInLoop({item:e,key:t,elements:r})}initForLoop(e,t=""){for(let r in t&&(t+="."),e)if(Array.isArray(e[r])){let i=t+r,l=this.container.querySelectorAll(`[${this.prefix}for="${i}"]`);l.forEach(e=>{this.listContainer[i]||(this.listContainer[i]=[],this.listElements[i]=[]);let t=e.firstElementChild.cloneNode(!0);this.listContainer[i].push(e),this.listElements[i].push(t),this.removeAllchildNodes(e)})}else"object"==typeof e[r]&&this.initForLoop(e[r],t+r)}performLoopOperation(e,t){this.listContainer[t]&&this.performLoopEachItem({item:e,key:t,elements:this.listContainer[t]})}addPropertyInLoop({item:e,key:t,elements:r}){r.forEach((r,i)=>{let l=this.listElements[t][i].cloneNode(!0),a=r.getAttribute(`${this.prefix}let`),o=l.getAttribute(`${this.prefix}filter`);if(Array.isArray(e.newValue)){let s=document.createDocumentFragment();e.newValue.forEach((r,l)=>{let n=this.listElements[t][i].cloneNode(!0),h={...e,currentPath:e.currentPath+"."+l,newValue:r};(!o||this.checkCondition(h,n,a,o))&&(this.updateAllPropertyToChildrenInLoop(h,n,a),s.appendChild(n))}),r.appendChild(s)}else{let n=r.getAttribute(`${this.prefix}let`),h=l.getAttribute(`${this.prefix}filter`);if(h&&!this.checkCondition(e,l,n,h))return;this.updateAllPropertyToChildrenInLoop(e,l,n),r.appendChild(l)}})}checkCondition(e,t,r,i,l=!0){let a=!0,o=i.split("==").map(e=>e.trim());return(1==o.length&&(a=!1,o=i.split("!=").map(e=>e.trim())),l&&(o[0].startsWith(r+".")&&(o[0]=o[0].replace(r,e.currentPath)),t.setAttribute(`${this.prefix}filter`,o.join("=="))),a)?this.getValueFromkeyWithDot(this.lib,o[0])==o[1]:this.getValueFromkeyWithDot(this.lib,o[0])!=o[1]}updateAllPropertyToChildrenInLoop(e,t,r){let i="object"==typeof e.newValue,l=i?this.generateKeyWithDotSeperated(e.newValue):[e.newValue];this.addAllAttributeToChildren(`${this.prefix}text`,e,t,r),this.addAllAttributeToChildren(`${this.prefix}if`,e,t,r),this.addAllAttributeToChildren(`${this.prefix}input`,e,t,r),this.addAttrClassToChildred(`${this.prefix}attr`,e,t,r,l),this.addAttrClassToChildred(`${this.prefix}class`,e,t,r,l);let a={...this.lib};l.forEach(r=>{let i={...e,newValue:a,currentPath:e.currentPath+"."+r};this.modifyMdInputValue(i,t,!0),this.modifyMdTextValue(i,t,!0),this.hideShowELement(i,t,!0)})}addAttrClassToChildred(e,t,r,i,l){let a=r.getAttribute(e);if(a&&a.includes(i)){let o=a.split(";").map(e=>(((e=e.split("=").map(e=>e.trim()))[1]==i||e[1].startsWith(i+"."))&&(e[1]=e[1].replace(i,t.currentPath)),e));r.setAttribute(e,o.map(e=>e.join("=")).join(";"))}let s=r.querySelectorAll(`[${e}]`);s.forEach(r=>{this.addAttrClassToChildred(e,t,r,i,l)})}addAllAttributeToChildren(e,t,r,i){let l=r.getAttribute(e);l&&(l==i?r.setAttribute(e,l.replace(i,t.currentPath)):l.startsWith(i+".")||e==`${this.prefix}if`&&l.startsWith("!"+i+".")?r.setAttribute(e,l.replaceAll(i+".",t.currentPath+".")):l&&l.includes("{{")&&(l=this.replaceVarNameInStringLiteral(i,l,t.currentPath),r.setAttribute(e,l)));let a=r.querySelectorAll(`[${e}]`);a.forEach(r=>{this.addAllAttributeToChildren(e,t,r,i)})}replaceVarNameInStringLiteral(e,t,r){let i=this.getAllKeyFromAttrWithBraces(t);return i.forEach(i=>{if(i){let l=RegExp(`{{\\s*(${i}?)\\s*}}`);l.exec(t)&&(t=t.replace(l,(t,i)=>{let l=t.replace(e,r);return l||0==l?l:t}))}}),t}addAttrInLoop(e,t,r,i,l){let a=t.getAttribute(i);if(a?.includes(r)){let o=!1,s="",n=a.split(";").map(t=>((t=t.split("=").map(e=>e.trim()))[1]==r&&(o=!0,s=e.currentPath+"."+r,t[1]=s),t));o&&l(e,n,t,r)}}addNestedLoopOp(e,t,r,i){let l=t.getAttribute(`${this.prefix}for`);if(l){l.startsWith(i+".")&&t.setAttribute(`${this.prefix}for`,l.replace(i,e.currentPath));let a=this.getValueFromkeyWithDot(this.lib,r),o=this.generateDefaultObjectType(a),s=t.firstElementChild.cloneNode(!0);t.removeChild(t.firstElementChild),o.forEach(e=>{let r=s.cloneNode(!0);this.addNestedLoopAttribute(r,`${this.prefix}text`,e.currentPath),this.addNestedLoopAttribute(r,`${this.prefix}input`,e.currentPath),this.addNestedLoopAttribute(r,`${this.prefix}if`,e.currentPath),t.appendChild(r)})}else t.querySelectorAll(`[${this.prefix}for]`).forEach(e=>{console.log(e)})}addNestedLoopAttribute(e,t,r){if(e.hasAttribute(t)){let i=e.getAttribute(t);e.setAttribute(t,r+`${i?"."+i:""}`)}else{let l=e.querySelectorAll(`[${t}]`);l.forEach(e=>{this.addNestedLoopAttribute(e,t,r)})}}updatePropertyInLoop({item:e,key:t,elements:r}){this.listContainer[t].forEach((r,i)=>{if(Array.isArray(e.newValue))this.removeAllchildNodes(r),this.addPropertyInLoop({item:e,key:t,elements:[r]});else if("object"==typeof e.newValue){let l=this.generateKeyWithDotSeperated(e.newValue);l.forEach(t=>{let i=r.querySelectorAll(`[${this.prefix}text="${e.currentPath+"."+t}"]`);i.forEach(r=>{let i=this.getValueFromkeyWithDot(e.newValue,t);r.textContent=i})})}else{let a=r.querySelectorAll(`[${this.prefix}text="${e.currentPath}"]`);a.forEach(t=>{t.textContent=e.newValue})}})}processChangeKeyUpEvent=this.debounceFunc(e=>this.performInputChangeEvent(e));debounceFunc(e,t=300){let r;return(...i)=>{clearTimeout(r),r=setTimeout(()=>{e.apply(this,i)},t)}}deletePropertInLoop({item:e,key:t,elements:r}){this.listContainer[t].forEach(t=>{let r=t.children;t.removeChild(r[e.property])})}static create(e,t={}){let r=new MiniJs(e,t);return r.init(e),r.lib}}